{% extends 'SonataDoctrineORMAdminBundle:Form:form_admin_fields.html.twig' %}

{% block sonata_admin_orm_one_to_many_widget %}
    {% include 'SonataDoctrineORMAdminBundle:CRUD:edit_orm_one_to_many.html.twig' %}
{% endblock %}

{% block choice_widget %}

    {% spaceless %}

        {{ parent() }}

        {% if refresh_route is defined %}

            {% autoescape false %}
            <script>

                cmb = $('#{{ form.vars.id }}');
                cmb.change(function (e) {

                    var form = jQuery(this).closest('form');

                    // el style se especifica porque el AdminLTE est√° desactualizado.
                    jQuery(this).closest('.box-body').prepend(
                        '<div class="overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%">' +
                        '<i class="fa fa-refresh fa-spin"></i>' +
                        '</div>'
                    );

                    jQuery(form).ajaxSubmit({

                        url: '{{ path(refresh_route, {
                            'elementId': form.parent.vars.id,
                            'objectId':  sonata_admin.admin.root.id(sonata_admin.admin.root.subject),
                            'uniqid':    sonata_admin.admin.root.uniqid,
                            'subclass': app.request.query.get('subclass'),
                        } + sonata_admin.field_description.getOption('link_parameters', {})) }}',
                        type: "POST",
                        dataType: 'html',
                        data: { _xml_http_request: true },
                        success: function(html) {

                            var tr = $('#tr-{{ form.parent.vars.id }}');
                            tr.html(html);
                            tr.closest('.box-body').find('.overlay').remove();

                            Admin.shared_setup(jQuery('#field_container_{{ form.parent.parent.vars.id }}'));
                            jQuery('#sonata-ba-field-container-{{ form.parent.parent.vars.id }}').trigger('sonata.add_element');
                            jQuery('#field_container_{{ form.parent.parent.vars.id }}').trigger('sonata.add_element');
                        }
                    });

                });

            </script>
            {% endautoescape %}

        {% endif %}

    {% endspaceless %}
{% endblock %}